<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RPA Dokumentasjonsportal{% endblock %}</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    
    <!-- Code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
                <i class="bi bi-robot"></i> RPA Portal
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">
                            <i class="bi bi-house"></i> Hjem
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'dev_docs' %}active{% endif %}" href="{{ url_for('dev_docs') }}">
                            <i class="bi bi-code-slash"></i> Tekniske l√∏sninger
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'process_docs' %}active{% endif %}" href="{{ url_for('process_docs') }}">
                            <i class="bi bi-gear"></i> Automatiserte prosesser
                        </a>
                    </li>
                </ul>

                <!-- Theme toggle button goes here -->
                <button id="themeToggle" class="btn btn-sm btn-outline-light ms-3" type="button" aria-label="Toggle dark mode">
                    <i class="bi bi-moon-stars"></i>
                </button>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
    <div class="container">
        <div class="row">
        <div class="col-md-6">
            <h6 class="text-primary">RPA Dokumentasjonsportal</h6>
            <p class="text-muted small">Dokumentasjon og veiledning for robotiserte prosesser</p>
        </div>
        <div class="col-md-6 text-md-end">
            <p class="text-muted small">
            Sist oppdatert: {{ moment().format('DD.MM.YYYY') if moment else 'I dag' }}
            </p>
            <p class="text-muted small mb-0">&copy; Samad Ismayilov 2025</p>
        </div>
        </div>
    </div>
    </footer>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Code highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <!-- Dark mode toggle script -->
    <script>
      (function () {
        const root = document.documentElement;
        const saved = localStorage.getItem('theme');
        if (saved === 'dark') root.setAttribute('data-theme', 'dark');

        const btn = document.getElementById('themeToggle');
        if (!btn) return;

        const setIcon = () => {
          const dark = root.getAttribute('data-theme') === 'dark';
          btn.innerHTML = dark ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon-stars"></i>';
          btn.setAttribute('aria-pressed', dark ? 'true' : 'false');
          btn.title = dark ? 'Lysmodus' : 'M√∏rk modus';
        };
        setIcon();

        btn.addEventListener('click', () => {
          const dark = root.getAttribute('data-theme') === 'dark';
          if (dark) {
            root.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
          } else {
            root.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
          }
          setIcon();
        });
      })();
    </script>

    <!-- Chat Widget -->
    <div id="chat-widget" class="chat-widget">
    <button id="chat-toggle" class="btn btn-primary rounded-pill shadow-sm">
        <i class="bi bi-chat-dots"></i> Chat
    </button>

    <div id="chat-panel" class="chat-panel card shadow-lg" hidden>
        <div class="card-header d-flex justify-content-between align-items-center">
        <!-- Stikkord / forslag -->
        <div class="chat-suggestions" aria-label="Hurtigvalg">
            <button type="button" class="btn btn-sm btn-outline-primary keyword" data-k="Asta">Asta</button>
            <button type="button" class="btn btn-sm btn-outline-primary keyword" data-k="historikksjekk">historikksjekk</button>
            <button type="button" class="btn btn-sm btn-outline-primary keyword" data-k="ekspedering av vedtak">ekspedering av vedtak</button>
            <button type="button" class="btn btn-sm btn-outline-primary keyword" data-k="Power Automate">Power Automate</button>
            <button type="button" class="btn btn-sm btn-outline-primary keyword" data-k="Power Automate Desktop">Power Automate Desktop</button>
            <button type="button" class="btn btn-sm btn-outline-primary keyword" data-k="Power Automate Cloud">Power Automate Cloud</button>
            <span class="hint-text ms-2">(Dobbelklikk for √• sende direkte)</span>
        </div>

  <!-- Lukk-knapp -->
  <button id="chat-close" class="btn btn-sm btn-outline-secondary" aria-label="Lukk">‚úï</button>
</div>

        <div id="chat-log" class="chat-log card-body" aria-live="polite"></div>

        <div class="card-footer">
        <form id="chat-form" class="d-flex gap-2">
            <input id="chat-input" type="text" class="form-control" placeholder="Still et sp√∏rsm√•l‚Ä¶" autocomplete="off" required>
            <button id="chat-send" class="btn btn-primary" type="submit">
            Send
            </button>
        </form>
        </div>
    </div>
    </div>

    <style>
    /* Du kan flytte dette til static/css/style.css om du vil */
    .chat-widget{position:fixed;right:16px;bottom:16px;z-index:1040}
    .chat-panel{width:800px;max-width:calc(100vw - 32px);height:620px;border-radius:1rem;display:flex;flex-direction:column;overflow:hidden}
    .chat-suggestions{display:flex;flex-wrap:wrap;gap:.35rem}
    .chat-suggestions .btn{border-radius:999px;padding:.2rem .6rem}
    .chat-log{flex:1;overflow:auto;gap:.5rem;display:flex;flex-direction:column}
    .msg{max-width:85%}
    .msg.user{align-self:flex-end;text-align:right}
    .bubble{display:inline-block;padding:.5rem .75rem;border-radius:.75rem}
    .bubble.user{background:var(--bs-primary-bg-subtle)}
    .bubble.bot{background:var(--bs-light)}
    .meta{font-size:.8rem;color:var(--bs-secondary-color);margin-top:.25rem}
    .sources{font-size:.8rem;margin-top:.25rem}
    .loading{opacity:.75;pointer-events:none}
    .hint-text {
    font-size: 0.8rem;
    color: var(--bs-secondary-color, #6c757d);
    align-self: center;
    /* layout with avatar + better text flow */
    .chat-log{flex:1;overflow:auto;gap:.5rem;display:flex;flex-direction:column;scroll-behavior:smooth}
    .msg{display:flex;gap:.5rem;align-items:flex-start;max-width:100%}
    .msg.user{justify-content:flex-end}
    .avatar{
    width:28px;height:28px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:var(--bs-primary-bg-subtle,#e7f1ff); color:var(--bs-primary,#0d6efd);
    flex:0 0 28px; font-size:16px; line-height:1;
    }
    .avatar.user{background:var(--bs-light);color:var(--bs-secondary)}
    .bubble{
    display:inline-block; padding:.5rem .75rem; border-radius:.75rem;
    max-width:min(100%, 64ch); white-space:pre-wrap; word-wrap:break-word;
    }
    .bubble.user{background:var(--bs-primary-bg-subtle)}
    .bubble.bot{background:var(--bs-light)}
    }

    </style>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
    (function(){
    const panel  = document.getElementById('chat-panel');
    const toggle = document.getElementById('chat-toggle');
    const closeB = document.getElementById('chat-close');
    const form   = document.getElementById('chat-form');
    const input  = document.getElementById('chat-input');
    const log    = document.getElementById('chat-log');

    let welcomed = false;

    function isNearBottom(){
        const delta = log.scrollHeight - log.scrollTop - log.clientHeight;
        return delta < 120; // consider "near bottom"
    }

    function addMsg(text, role='bot', sources){
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + role;

        // avatar
        const av = document.createElement('div');
        av.className = 'avatar ' + role;
        av.innerHTML = role === 'bot' ? '<i class="bi bi-robot"></i>' : '<i class="bi bi-person-circle"></i>';

        // bubble
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + role;
        if (role === 'bot') {
        // Hvis meldingen ser ut som HTML (starter med <), bruk direkte
        if ((text || '').trim().startsWith('<')) {
            bubble.innerHTML = text;
        } else {
            bubble.innerHTML = marked.parse(text || '');
        }
        } else {
        bubble.textContent = text || '';
        }


        if (role === 'bot'){
        wrap.appendChild(av);
        wrap.appendChild(bubble);
        } else {
        wrap.appendChild(bubble);
        wrap.appendChild(av);
        }

        if (Array.isArray(sources) && sources.length){
        const s = document.createElement('div');
        s.className = 'sources';
        s.innerHTML = 'Kilder: ' + sources.map(src =>
            `<code>${src.file}#${src.section}</code>`).join(', ');
        bubble.appendChild(document.createElement('br'));
        bubble.appendChild(s);
        }

        const shouldScroll = isNearBottom() || role === 'user';
        log.appendChild(wrap);
        if (shouldScroll) log.scrollTop = log.scrollHeight;
    }

    // Keyword chips
    document.querySelectorAll('.chat-suggestions .keyword').forEach(btn=>{
        btn.addEventListener('click', ()=>{
        const k = btn.dataset.k || btn.textContent.trim();
        const v = input.value.trim();
        const has = v.toLowerCase().includes(k.toLowerCase());
        if (!v) input.value = k + ' ';
        else if (!has) input.value = v + ' ' + k;
        input.focus();
        });
        // double-click to send immediately
        btn.addEventListener('dblclick', ()=>{
        if (input.form) input.form.dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
        });
    });

    // Friendly welcome (first open)
    function showWelcome(){
        const msg = `
        <h5><strong>Hei! Jeg er Dokumentasjonsbot ü§ñ</strong></h5>
        <p>Jeg hjelper deg √• finne informasjon i dokumentasjonen (kun <code>.md</code>-filene p√• dette nettstedet).</p>
        <ul>
            <li><strong>Tips:</strong> Bruk <em>stikkord</em> (f.eks. <em>Asta</em>, <em>historikksjekk</em>, <em>ekspedering av vedtak</em>, <em>Power Automate Desktop</em>).</li>
            <li><strong>Begrensninger:</strong> Jeg genererer ikke nytt innhold ‚Äì jeg viser bare utdrag fra dokumentene. Hvis noe ikke finnes i dokumentasjonen, sier jeg fra.</li>
            <li><strong>Kontakt:</strong> Nettsiden er under utvikling. Sp√∏rsm√•l/innspill? Ta kontakt med <em>Samad Ismayilov</em>.</li>
        </ul>
        `;
        addMsg(msg, 'bot');
    }



    toggle.addEventListener('click', ()=>{
        panel.hidden = !panel.hidden;
        if (!panel.hidden) {
        if (!welcomed){ showWelcome(); welcomed = true; }
        input.focus();
        }
    });
    closeB.addEventListener('click', ()=> panel.hidden = true);

    form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const q = input.value.trim();
        if(!q) return;
        addMsg(q, 'user');
        input.value = '';
        form.classList.add('loading');

        try{
        const r = await fetch('/ask', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({question:q})
        });
        const data = await r.json();
        if (!r.ok) {
            addMsg('Teknisk feil. Pr√∏v igjen senere.', 'bot');
        } else {
            addMsg(data.answer || 'Ingen svar.', 'bot', data.sources || []);
        }
        }catch(err){
        addMsg('Nettverksfeil. Er serveren i gang?', 'bot');
        }finally{
        form.classList.remove('loading');
        }
    });
    })();
    </script>

</body>
</html>
